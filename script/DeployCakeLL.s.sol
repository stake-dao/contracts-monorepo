// SPDX-License-Identifier: AGPL-3.0-only
pragma solidity 0.8.19;

import "forge-std/Test.sol";
import "forge-std/Script.sol";

import {AddressBook} from "@addressBook/AddressBook.sol";
import {CAKEDepositor} from "src/cake/depositor/CAKEDepositor.sol";
import {CakeLocker} from "src/cake/locker/CakeLocker.sol";
import {sdToken} from "src/base/token/sdToken.sol";
import {ILiquidityGauge} from "src/base/interfaces/ILiquidityGauge.sol";

contract DeployCakeLL is Script, Test {
    sdToken internal _sdToken;
    ILiquidityGauge internal liquidityGauge;
    CAKEDepositor private depositor;
    CakeLocker private locker;

    address public constant CAKE = 0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82;
    address public constant VE_CAKE = 0x5692DB8177a81A6c6afc8084C2976C9933EC1bAB;
    address public constant GOV = 0x000755Fbe4A24d7478bfcFC1E561AfCE82d1ff62;
    address public DEPLOYER = 0x000755Fbe4A24d7478bfcFC1E561AfCE82d1ff62;

    bytes public constant LGV4_BYTECODE = bytes(
        hex"34610245576020611cec6000396000518060a01c610245576040526020611d0c6000396000518060a01c6102455760605260405115610245576060511561024557606051601b5560405160015560405163313ce567608052602060806004609c845afa610071573d600060003e3d6000fd5b60203d106102455760809050516002556040516395d89b4160c052606060c0600460dc845afa6100a6573d600060003e3d6000fd5b60403d106102455760c05160c001601a815111610245578051610140526020810151610160525061014090508051608052602081015160a052506000600a60c0527f5374616b652044414f200000000000000000000000000000000000000000000060e05260c0805160208201836101600181518152505080830192505050608051816101600160a0518152508082019150506006610100527f204761756765000000000000000000000000000000000000000000000000000061012052610100805160208201836101600181518152505080830192505050806101405261014090506020815101600081601f0160051c600381116102455780156101be57905b8060051b84015181600601556001018181186101a7575b505050506000608051816101200160a051815250808201915050600660c0527f2d6761756765000000000000000000000000000000000000000000000000000060e05260c08051602082018361012001815181525050808301925050508061010052610100905080516009556020810151600a5550611a8d61024a61000039611a8d610000f35b600080fd60003560e01c60026024820660011b611a4501601e39600051565b632dc7d74c81186114415734611a405760015460405260206040f3611441565b63178f318581186100565734611a405760025460405260206040f35b6354c49fe9811861008357602436103417611a405760043560098111611a4057600d015460405260206040f35b63b6b55f25811861144157602436103417611a4057336104a05260006104c052610c8456611441565b6370a0823181186100e957602436103417611a40576004358060a01c611a4057604052600360405160205260005260406000205460605260206060f35b6318160ddd81186114415734611a405760045460405260206040f3611441565b63dd62ed3e811861016557604436103417611a40576004358060a01c611a40576040526024358060a01c611a40576060526005604051602052600052604060002080606051602052600052604060002090505460805260206080f35b6317f7182a81186114415734611a4057601c5460405260206040f3611441565b6306fdde0381186102025734611a405760208060405280604001602060065401600081601f0160051c60038111611a405780156101d557905b80600601548160051b8501526001018181186101be575b5050508051806020830101601f82600003163682375050601f19601f825160200101169050810190506040f35b6393f7aa67811861144157604436103417611a40576004358060a01c611a40576104a052600054600214611a4057600260005560176104a0516020526000526040600020600181019050543318611a40576000610380526004546103a0526040366103c03761026f6117f8565b6104a0515a60006004610500527f23b872dd000000000000000000000000000000000000000000000000000000006105205261050080516020820183610560018151815250508083019250505033816105600152602081019050308161056001526020810190506024358161056001526020810190508061054052610540505060206106006105405161056060008686f190509050610313573d600060003e3d6000fd5b3d602081183d60201002186105e0526105e080516104c05260208101516104e052506104c05115610353576104e0516104c05160200360031b1c15611a40575b60176104a05160205260005260406000206002810190505461050052610500514210156103ff576105005142808203828111611a405790509050610520526105205160176104a051602052600052604060002060038101905054808202811583838304141715611a4057905090506105405260243561054051808201828110611a40579050905062093a808104905060176104a051602052600052604060002060038101905055610423565b60243562093a808104905060176104a0516020526000526040600020600381019050555b4260176104a0516020526000526040600020600481019050554262093a808101818110611a4057905060176104a0516020526000526040600020600281019050556104a0517f656e648408f08a8f933b2d1375eb24c442eafd5537451a75561a264a56963922602435610520526020610520a2600360005500611441565b6395d89b4181186104f25734611a4057602080604052806040016009548152600a5460208201528051806020830101601f82600003163682375050601f19601f825160200101169050810190506040f35b63963c94b981186114415734611a4057600c5460405260206040f3611441565b639bd324f2811861144157602436103417611a40576004358060a01c611a4057604052600b60405160205260005260406000205460605260206060f3611441565b6348e9c65e81186105bb57602436103417611a40576004358060a01c611a40576040526017604051602052600052604060002080546060526001810154608052600281015460a052600381015460c052600481015460e0526005810154610100525060c06060f35b63449a533a811861144157604436103417611a40576004358060a01c611a40576104a0526024358060a01c611a40576104c052600054600214611a4057600260005533601d5418611a40576104a0516104c0511461062057601d546104c05118611a40575b6104a051610380526004546103a05260016103c0526104c0516103e0526106456117f8565b600360005500611441565b6301ddabf1811861068d57602436103417611a40576004358060a01c611a4057604052601860405160205260005260406000205460605260206060f35b63e8de0d4d811861144157604436103417611a40576004358060a01c611a40576040526024358060a01c611a4057606052601b546080526080513318611a405760405115611a4057600c5460a052600960a05111611a40576017604051602052600052604060002060018101905054611a4057606051601760405160205260005260406000206001810190505560405160a05160098111611a4057600d015560a05160018101818110611a40579050600c5500611441565b63f05cc058811861144157604436103417611a40576004358060a01c611a40576040526024358060a01c611a40576060526019604051602052600052604060002080606051602052600052604060002090505460805260206080f3611441565b63f851a44081186114415734611a4057601b5460405260206040f3611441565b63d379be2381186107e15734611a4057601d5460405260206040f35b639faceb1b811861144157604436103417611a40576004358060a01c611a40576104a0526024358060a01c611a40576104c0525b600054600214611a405760026000556104c0511561083857336104a05118611a40575b6104a051610380526004546103a05260016103c0526104c0516103e05261085d6117f8565b600360005500611441565b63313ce56781186108845734611a405760025460405260206040f35b63e77e7437811861144157604436103417611a40576004358060a01c611a40576040526024358060a01c611a4057606052601a60405160205260005260406000208060605160205260005260406000209050546fffffffffffffffffffffffffffffffff8116905060805260206080f3611441565b6333fd6f748118610acf57604436103417611a40576004358060a01c611a40576040526024358060a01c611a4057606052601760605160205260005260406000206005810190505460805260045460a052600360405160205260005260406000205460c05260a05115610a2c574260176060516020526000526040600020600281019050548082811882841002189050905060e05260e0516017606051602052600052604060002060048101905054808203828111611a40579050905061010052608051610100516017606051602052600052604060002060038101905054808202811583838304141715611a405790509050670de0b6b3a7640000810281670de0b6b3a7640000820418611a4057905060a0518015611a405780820490509050808201828110611a4057905090506080525b6019606051602052600052604060002080604051602052600052604060002090505460e05260c05160805160e051808203828111611a405790509050808202811583838304141715611a405790509050670de0b6b3a76400008104905061010052601a604051602052600052604060002080606051602052600052604060002090505460801c61010051808201828110611a405790509050610120526020610120f35b63058a3a24811861144157604436103417611a40576004358060a01c611a40576040526024358060a01c611a40576060526017604051602052600052604060002060018101905054608052601b5460a0526080513318610b30576001610b37565b60a0513318155b15611a405760805115611a405760605115611a4057606051601760405160205260005260406000206001810190505500611441565b63bdf98116811861144157602436103417611a40576004358060a01c611a405760405260405160183360205260005260406000205500611441565b63e6f1daf281186114415734611a4057336104a05260006104c05261081556611441565b6384e9bd7e8118610bfa57602436103417611a40576004358060a01c611a40576104a05260006104c052610815565b62f714ce811861144157604436103417611a405760006104c052610e8a56611441565b636e553f65811861144157604436103417611a40576024358060a01c611a40576104a05260006104c052610c8456611441565b6383df67478118610e2057606436103417611a40576024358060a01c611a40576104a0526044358060011c611a40576104c0525b600054600214611a405760026000556004546104e05260043515610d9457600c541515610500526105005115610cda576104a051610380526104e0516103a0526104c0516103c05260006103e052610cda6117f8565b6104e051600435808201828110611a4057905090506104e05260036104a051602052600052604060002054600435808201828110611a405790509050610520526105205160036104a0516020526000526040600020556104e0516004556001546323b872dd61054052336105605230610580526004356105a0526020610540606461055c6000855af1610d72573d600060003e3d6000fd5b60203d10611a4057610540518060011c611a40576105c0526105c05050610db3565b6104a051610380526104e0516103a0526040366103c037610db36117f8565b6104a0517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c600435610500526020610500a26104a05160007fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610500526020610500a36003600055005b6329de95bf811861144157602436103417611a40576004358060a01c611a4057604052601b546060526060513318611a405760405115611a4057604051601d5500611441565b62ebf5dd811861102d57606436103417611a40576044358060011c611a40576104c0525b6024358060a01c611a40576104a052600054600214611a405760026000556004546104e05260043515610fa457600c541515610500526105005115610eef576104a051610380526104e0516103a0526104c0516103c05260006103e052610eef6117f8565b6104e051600435808203828111611a4057905090506104e05260036104a051602052600052604060002054600435808203828111611a405790509050610520526105205160036104a0516020526000526040600020556104e05160045560015463a9059cbb610540523361056052600435610580526020610540604461055c6000855af1610f82573d600060003e3d6000fd5b60203d10611a4057610540518060011c611a40576105a0526105a05050610fc3565b6104a051610380526104e0516103a0526040366103c037610fc36117f8565b6104a0517f884edad9ce6fa2440d8a54cc123490eb96d2768479d49ff9c7366125a9424364600435610500526020610500a26000337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef600435610500526020610500a36003600055005b6323b872dd811861144157606436103417611a40576004358060a01c611a4057610560526024358060a01c611a405761058052600054600214611a405760026000556005610560516020526000526040600020803360205260005260406000209050546105a0527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff6105a051146110f5576105a051604435808203828111611a4057905090506005610560516020526000526040600020803360205260005260406000209050555b610560516104a052610580516104c0526044356104e0526111146118df565b60016105c05260206105c06003600055f3611441565b63a9059cbb811861144157604436103417611a40576004358060a01c611a405761056052600054600214611a40576002600055336104a052610560516104c0526024356104e0526111796118df565b60016105805260206105806003600055f3611441565b63095ea7b3811861144157604436103417611a40576004358060a01c611a40576040526024356005336020526000526040600020806040516020526000526040600020905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560243560605260206060a3600160605260206060f3611441565b6339509351811861144157604436103417611a40576004358060a01c611a40576040526005336020526000526040600020806040516020526000526040600020905054602435808201828110611a4057905090506060526060516005336020526000526040600020806040516020526000526040600020905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611441565b63a457c2d7811861144157604436103417611a40576004358060a01c611a40576040526005336020526000526040600020806040516020526000526040600020905054602435808203828111611a4057905090506060526060516005336020526000526040600020806040516020526000526040600020905055604051337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560605160805260206080a3600160805260206080f3611441565b636b441a4081186113ee57602436103417611a40576004358060a01c611a4057604052601b543318611a405760405115611a4057604051601c557f2f56810a6bf40af059b96d3aea4db54081f378029a518390491093a7b67032e960405160605260206060a1005b63e5ea47b881186114415734611a4057601c546040526040513318611a4057604051601b557febee2d5739011062cb4f14113f3b36bf0ffe3da5c0568f64189d1012a118910560405160605260206060a1005b60006000fd5b6080516101005260a051610120526017606051602052600052604060002060058101905054610140524260176060516020526000526040600020600281019050548082811882841002189050905061016052610160516017606051602052600052604060002060048101905054808203828111611a4057905090506101805261018051156115835761016051601760605160205260005260406000206004810190505561010051156115835761014051610180516017606051602052600052604060002060038101905054808202811583838304141715611a405790509050670de0b6b3a7640000810281670de0b6b3a7640000820418611a40579050610100518015611a405780820490509050808201828110611a405790509050610140526101405160176060516020526000526040600020600581019050555b604051156117f657601960605160205260005260406000208060405160205260005260406000209050546101a05260006101c052610140516101a051101561162b57610140516019606051602052600052604060002080604051602052600052604060002090505561012051610140516101a051808203828111611a405790509050808202811583838304141715611a405790509050670de0b6b3a7640000810490506101c0525b601a60405160205260005260406000208060605160205260005260406000209050546101e0526101e05160801c6101c051808201828110611a4057905090506102005261020051156117f6576101e0516fffffffffffffffffffffffffffffffff811690506102205260c0516116e4576101c051156117f657610220516102005160801b808201828110611a405790509050601a60405160205260005260406000208060605160205260005260406000209050556117f6565b6060515a60006004610280527fa9059cbb000000000000000000000000000000000000000000000000000000006102a052610280805160208201836102e0018151815250508083019250505060e051816102e0015260208101905061020051816102e00152602081019050806102c0526102c0505060206103606102c0516102e060008686f19050905061177d573d600060003e3d6000fd5b3d602081183d6020100218610340526103408051610240526020810151610260525061024051156117bd57610260516102405160200360031b1c15611a40575b6102205161020051808201828110611a405790509050601a60405160205260005260406000208060605160205260005260406000209050555b565b6103e05161040052600061042052610380511561186657600361038051602052600052604060002054610420526103c05161183457600061183a565b6103e051155b156118665760186103805160205260005260406000205461040052610400516118665761038051610400525b600c54610440526000600a905b806104605261044051610460511861188a576118db565b6104605160098111611a4057600d01546104805261038051604052610480516060526103a0516080526104205160a0526103c05160c0526104005160e0526118d0611447565b600101818118611873575b5050565b600454610500526104e051156119c957600c541515610520526105205115611920576104a05161038052610500516103a0526040366103c0376119206117f8565b60036104a0516020526000526040600020546104e051808203828111611a405790509050610540526105405160036104a0516020526000526040600020556105205115611986576104c05161038052610500516103a0526040366103c0376119866117f8565b60036104c0516020526000526040600020546104e051808201828110611a405790509050610540526105405160036104c051602052600052604060002055611a07565b6104a05161038052610500516103a0526040366103c0376119e86117f8565b6104c05161038052610500516103a0526040366103c037611a076117f8565b6104c0516104a0517fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef6104e051610520526020610520a3565b600080fd144100ac0512086813860c1d0553112a144114411441118f0745144114410c50001a1214010914411441003a0b6c144108f906500bcb12cd14410e661441018507a504a10ba707c584191a8d81184800a16576797065728300030a0015"
    );

    function run() public {
        vm.startBroadcast(DEPLOYER);

        // // Deploy sdCAKE
        _sdToken = new sdToken("Stake DAO CAKE", "sdCAKE");
        bytes memory args = abi.encode(address(_sdToken), GOV);

        ///@notice deploy the bytecode with the create instruction
        address deployedAddress;
        deployedAddress = deployBytecode(LGV4_BYTECODE, args);

        liquidityGauge = ILiquidityGauge(deployedAddress);
        /// Deploy CAKE Locker
        locker = new CakeLocker(DEPLOYER, CAKE, VE_CAKE);

        /// Deploy CAKE Depositor
        depositor = new CAKEDepositor(CAKE, address(locker), address(_sdToken), address(liquidityGauge));

        /// Setters
        locker.setDepositor(address(depositor));
        _sdToken.setOperator(address(depositor));

        vm.stopBroadcast();
    }

    function deployBytecode(bytes memory bytecode, bytes memory args) private returns (address deployed) {
        bytecode = abi.encodePacked(bytecode, args);

        assembly {
            deployed := create(0, add(bytecode, 0x20), mload(bytecode))
        }

        require(deployed != address(0), "DEPLOYMENT_FAILED");
    }
}
